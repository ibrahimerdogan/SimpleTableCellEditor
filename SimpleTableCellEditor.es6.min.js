window.onload=function(){if(!window.jQuery)throw"jQuery is not loaded"};class SimpleTableCellEdition{constructor(elem,_cellParams){this.Elem=elem,this.oldContent=$(elem).html(),this.oldValue=_cellParams.internals.extractValue(elem),this.cellParams=_cellParams}}class SimpleTableCellEditor{constructor(_tableId,_params){var _instance=this;_instance.EditionEndOrigin={OutsideTable:1,AnotherCell:2},void 0===_tableId&&(_tableId="table"),this.active=!0,this.tableId=_tableId,this.params=_instance._GetExtendedEditorParams(_params),this.CellEdition=null,this._TryHandleDataTableReloadEvent(),$(document).mouseup((function(e){var container=$(`#${_instance.tableId}`);container.is(e.target)||0!==container.has(e.target).length||_instance._FreeCurrentCell(_instance.EditionEndOrigin.OutsideTable)}))}SetEditable(elem,_cellParams){var _instance=this;if(_instance._isValidElem(elem)){var cellParams=_instance._GetExtendedCellParams(_cellParams);$(elem).on("click",(function(evt){_instance.active&&($(this).hasClass(_instance.params.inEditClass)||_instance._EditCell(this,cellParams))})),$(elem).on("keydown",(function(event){_instance.active&&$(this).hasClass(_instance.params.inEditClass)&&_instance._HandleKeyPressed(event.which,this,cellParams)}))}}SetEditableClass(editableClass,_cellParams){var _instance=this,cellParams=_instance._GetExtendedCellParams(_cellParams);$(`#${_instance.tableId}`).on("click",`td.${editableClass}:not(.${_instance.params.inEditClass})`,(function(){_instance.active&&_instance._EditCell(this,cellParams)})),$(`#${_instance.tableId}`).on("keydown",`td.${editableClass}.${_instance.params.inEditClass}`,(function(event){_instance.active&&_instance._HandleKeyPressed(event.which,this,cellParams)}))}Toggle(_active){void 0===_active&&(_active=!this.active),this.active=_active}_HandleKeyPressed(which,elem,cellParams){cellParams.keys.validation.includes(which)?this._FreeCell(elem,cellParams,!0):cellParams.keys.cancellation.includes(which)&&this._FreeCell(elem,cellParams,!1)}_EditCell(elem,cellParams){var onEditEnterEvent;if(!this._FireOnEditEnterEvent(elem).isDefaultPrevented()){this._FreeCurrentCell(this.EditionEndOrigin.AnotherCell),this.CellEdition=new SimpleTableCellEdition(elem,cellParams),this.isDataTable&&(this.CellEdition.cellIndex=$(`#${this.tableId}`).DataTable().cell($(elem)).index());var oldVal=cellParams.internals.extractValue(elem);$(elem).addClass(this.params.inEditClass),cellParams.internals.renderEditor(elem,oldVal),this._FireOnEditEnteredEvent(elem,oldVal)}}_EndEditCell(elem,cellParams){this._FreeCell(elem,cellParams,!0)}_CancelEditCell(elem,cellParams){this._FreeCell(elem,cellParams,!1)}_FreeCell(elem,cellParams,keepChanges){var onEditExitEvent;if(this._isValidElem(elem)&&null!==this.CellEdition&&!this._FireOnEditExitEvent(elem,this.CellEdition.oldValue).isDefaultPrevented()){var newVal=cellParams.internals.extractEditorValue(elem);$(elem).removeClass(this.params.inEditClass),$(elem).html(""),cellParams.validation(newVal)&&this.CellEdition.oldValue!==newVal||(keepChanges=!1);var formattedNewVal=cellParams.formatter(newVal);this._FireOnEditExitedEvent(elem,this.CellEdition.oldValue,formattedNewVal,keepChanges),keepChanges?(cellParams.internals.renderValue(elem,formattedNewVal),this._FireEditedEvent(elem,this.CellEdition.oldValue,formattedNewVal)):$(elem).html(this.CellEdition.oldContent),this.CellEdition=null}}_FreeCurrentCell(editionEndOrigin){var current=this._GetCurrentEdition();if(null!==current){var keepChanges=!0;editionEndOrigin===this.EditionEndOrigin.OutsideTable&&current.cellParams.behaviour.outsideTableClickCauseCancellation&&(keepChanges=!1),editionEndOrigin===this.EditionEndOrigin.AnotherCell&&current.cellParams.behaviour.anotherCellClickCauseCancellation&&(keepChanges=!1),this._FreeCell(current.Elem,current.cellParams,keepChanges)}}_GetCurrentEdition(){return null===this.CellEdition?null:this.CellEdition}_GetExtendedEditorParams(_params){var _instance=this;return $.extend(!0,{},this._GetDefaultEditorParams(),_params)}_GetExtendedCellParams(_cellParams){var _instance=this;return $.extend(!0,{},this._GetDefaultCellParams(),_cellParams)}_FireOnEditEnterEvent(elem){var evt=jQuery.Event("cell:onEditEnter",{element:elem});return $(`#${this.tableId}`).trigger(evt),evt}_FireOnEditEnteredEvent(elem,oldVal){$(`#${this.tableId}`).trigger({type:"cell:onEditEntered",element:elem,oldValue:oldVal})}_FireOnEditExitEvent(elem,oldVal){var evt=jQuery.Event("cell:onEditExit",{element:elem,oldValue:oldVal});return $(`#${this.tableId}`).trigger(evt),evt}_FireOnEditExitedEvent(elem,oldVal,newVal,applied){$(`#${this.tableId}`).trigger({type:"cell:onEditExited",element:elem,newValue:newVal,oldValue:oldVal,applied:applied})}_FireEditedEvent(elem,oldVal,newVal){$(`#${this.tableId}`).trigger({type:"cell:edited",element:elem,newValue:newVal,oldValue:oldVal})}_TryHandleDataTableReloadEvent(){var _instance=this;this.isDataTable=!1;try{$.fn.DataTable.isDataTable(`#${_instance.tableId}`)&&(_instance.isDataTable=!0)}catch(e){return}_instance.isDataTable&&$(`#${_instance.tableId}`).on("draw.dt",(function(){if(null!==_instance.CellEdition&&null!==_instance.CellEdition.Elem){var node=$(`#${_instance.tableId}`).DataTable().cell(_instance.CellEdition.cellIndex).node();_instance._EditCell(node,_instance.CellEdition.cellParams)}}))}_GetDefaultEditorParams(){return{inEditClass:"inEdit"}}_GetDefaultCellParams(){return{validation:value=>!0,formatter:value=>value,keys:{validation:[13],cancellation:[27]},behaviour:{outsideTableClickCauseCancellation:!1,anotherCellClickCauseCancellation:!1},internals:this._GetDefaultInternals()}}_GetDefaultInternals(){return{renderValue:(elem,formattedNewVal)=>{$(elem).text(formattedNewVal)},renderEditor:(elem,oldVal)=>{$(elem).html("<input type='text' style=\"width:100%; max-width:none\">");var input=$(elem).find("input");input.focus(),input.val(oldVal)},extractEditorValue:elem=>$(elem).find("input").val(),extractValue:elem=>$(elem).text()}}_isValidElem(elem){return null!=elem&&$(elem).length>0}}